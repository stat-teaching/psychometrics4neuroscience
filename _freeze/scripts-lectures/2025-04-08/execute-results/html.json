{
  "hash": "b9ed9fa68f483ce3e027cf281cd2367d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"2025-04-08\"\nformat: html\n---\n\n\n\nSimuliamo dati fissando una certa correlazione pre-post come ICC:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(lme4)\n\nn <- 1e4\nr <- 0.7 # icc = r\nb0 <- 0\nb1 <- 0.3\nsb0 <- sqrt(r)\ns <- sqrt(1 - sb0^2)\n\ndat <- data.frame(\n    x = rep(0:1, each = n),\n    id = rep(1:n, 2)\n)\n\nb0i <- rnorm(n, 0, sb0)\ndat$y <- rnorm(n*2, with(dat, b0 + b0i[id] + b1 * x), s)\n\nfit <- lmer(y ~ x + (1|id), data = dat)\nsummary(fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLinear mixed model fit by REML ['lmerMod']\nFormula: y ~ x + (1 | id)\n   Data: dat\n\nREML criterion at convergence: 50018.8\n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-3.1288 -0.5133 -0.0030  0.5213  3.2586 \n\nRandom effects:\n Groups   Name        Variance Std.Dev.\n id       (Intercept) 0.6961   0.8343  \n Residual             0.3007   0.5484  \nNumber of obs: 20000, groups:  id, 10000\n\nFixed effects:\n             Estimate Std. Error t value\n(Intercept) -0.008000   0.009984  -0.801\nx            0.303728   0.007755  39.166\n\nCorrelation of Fixed Effects:\n  (Intr)\nx -0.388\n```\n\n\n:::\n\n```{.r .cell-code}\nsb0^2 / (sb0^2 + s^2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.7\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLinear mixed model fit by REML ['lmerMod']\nFormula: y ~ x + (1 | id)\n   Data: dat\n\nREML criterion at convergence: 50018.8\n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-3.1288 -0.5133 -0.0030  0.5213  3.2586 \n\nRandom effects:\n Groups   Name        Variance Std.Dev.\n id       (Intercept) 0.6961   0.8343  \n Residual             0.3007   0.5484  \nNumber of obs: 20000, groups:  id, 10000\n\nFixed effects:\n             Estimate Std. Error t value\n(Intercept) -0.008000   0.009984  -0.801\nx            0.303728   0.007755  39.166\n\nCorrelation of Fixed Effects:\n  (Intr)\nx -0.388\n```\n\n\n:::\n\n```{.r .cell-code}\nperformance::icc(fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# Intraclass Correlation Coefficient\n\n    Adjusted ICC: 0.698\n  Unadjusted ICC: 0.683\n```\n\n\n:::\n:::\n\n\n\nSimuliamo random-intercepts e slopes con anche l'effetto di una covariata al livello del soggetto.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nn <- 10\nnt <- 10\n\nage <- round(runif(n, 20, 30))\n\ndat <- expand.grid(\n    id = 1:n,\n    trial = 1:nt,\n    x = c(0, 1)\n)\n\ndat$age <- age[dat$id]\n\nb0 <- 0.1\nb1 <- 0.5\nb2 <- 0.1\nsb0 <- 0.2\nsb1 <- 0.1\ns <- 1\n\nrb0b1 <- 0.5\n\nR <- rb0b1 + diag(1 - rb0b1, 2)\nS <- diag(c(sb0, sb1)) %*% R %*% diag(c(sb0, sb1))\n\nZ <- MASS::mvrnorm(n, c(0, 0), S)\n\nb0i <- Z[, 1]\nb1i <- Z[, 2]\n\ndat$age0 <- dat$age - mean(dat$age)\ndat$lp <- b0 + b0i[dat$id] + (b1 + b1i[dat$id]) * dat$x + b2 * dat$age0\ndat$y <- rnorm(nrow(dat), dat$lp, s)\nfit <- lmer(y ~ x + age + (x|id), dat = dat)\n\nsummary(fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLinear mixed model fit by REML ['lmerMod']\nFormula: y ~ x + age + (x | id)\n   Data: dat\n\nREML criterion at convergence: 582.7\n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-3.2763 -0.5854  0.0459  0.6215  2.4063 \n\nRandom effects:\n Groups   Name        Variance  Std.Dev. Corr\n id       (Intercept) 7.060e-02 0.265698     \n          x           4.231e-06 0.002057 1.00\n Residual             9.979e-01 0.998936     \nNumber of obs: 200, groups:  id, 10\n\nFixed effects:\n            Estimate Std. Error t value\n(Intercept) -3.03737    0.87610  -3.467\nx            0.35413    0.14127   2.507\nage          0.12548    0.03282   3.824\n\nCorrelation of Fixed Effects:\n    (Intr) x     \nx   -0.080       \nage -0.989  0.000\noptimizer (nloptwrap) convergence code: 0 (OK)\nboundary (singular) fit: see help('isSingular')\n```\n\n\n:::\n\n```{.r .cell-code}\nperformance::r2(fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRandom effect variances not available. Returned R2 does not account for random effects.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# R2 for Mixed Models\n\n  Conditional R2: NA\n     Marginal R2: 0.173\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(ggplot2)\n\ndat |> \n    ggplot(aes(x = age, y = y)) +\n    geom_point(aes(color = factor(x)))\n```\n\n::: {.cell-output-display}\n![](2025-04-08_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n\nSimuliamo un modello logit:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nn <- 100\nnt <- 1e3\nb0 <- qlogis(0.01)\nb1 <- 10\nsb0 <- 1\n\n# plogis(qlogis(0.01) + rnorm(1e4, 0, sb0)) |> \n#     hist()\n\n\ndd <- expand.grid(\n    id = 1:n,\n    nt = 1:nt\n)\n\ndd$x <- runif(nrow(dd), 0, 1)\nb0i <- rnorm(n, 0, sb0)\n\ndd$lp <-  + b1 * dd$x\ndd$p <- plogis(dd$lp)\n\n# dd |> \n#     ggplot(aes(x = x, y = p, group = id)) +\n#     geom_line()\n\ndd$y <- rbinom(nrow(dd), 1, dd$p)\n\nlibrary(lme4)\n\nfit <- glmer(y ~ x + (1|id),\n             data = dd, \n             family = binomial())\n\nperformance::icc(fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] NA\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nGeneralized linear mixed model fit by maximum likelihood (Laplace\n  Approximation) [glmerMod]\n Family: binomial  ( logit )\nFormula: y ~ x + (1 | id)\n   Data: dd\n\n      AIC       BIC    logLik -2*log(L)  df.resid \n  32799.4   32828.0  -16396.7   32793.4     99997 \n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-67.165   0.016   0.056   0.204   1.008 \n\nRandom effects:\n Groups Name        Variance Std.Dev.\n id     (Intercept) 0        0       \nNumber of obs: 100000, groups:  id, 100\n\nFixed effects:\n            Estimate Std. Error z value Pr(>|z|)    \n(Intercept) -0.01598    0.02193  -0.729    0.466    \nx           10.12262    0.12273  82.476   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nCorrelation of Fixed Effects:\n  (Intr)\nx -0.764\noptimizer (Nelder_Mead) convergence code: 0 (OK)\nboundary (singular) fit: see help('isSingular')\n```\n\n\n:::\n\n```{.r .cell-code}\n# intraclass correlation con varianza della logistica come costante\n0.8821 / (0.8821 + pi^2/3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.211435\n```\n\n\n:::\n:::\n",
    "supporting": [
      "2025-04-08_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}